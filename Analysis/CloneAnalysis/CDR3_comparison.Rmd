---
title: "CDR3 comparison"
author: "Nils Eling"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Clones/CDR3_comparison.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script studies the similarities of clone composition between different samples.

## Read in data

```{r}
library(plyr)
library(reshape2)
library(ggplot2)
library(cowplot)
library(pheatmap)
source("../../Functions/auxiliary.R")

# Read in mixcr mapping results - one chain per .txt file
all.files <- list.files("/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Clones/Txt_files", full.names = TRUE)

# Read in normalized counts
norm <- read.table("/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Data/NormCounts.txt", sep = "\t", header = TRUE)
libraries <- sapply(colnames(norm), function(n){unlist(strsplit(n, "_"))[4]})

# Remove low quality libraries
all.files <- grep(paste(libraries,collapse="|"), all.files, value=TRUE, ignore.case = TRUE)
```

# TRG

## Collect top 20 expanded clones for each old library

```{r expansion}
# Find clones
Vg1_old_TRG_V1 <- topCDR3(all.files, top = 10, keywords = c("Vg1", "old", "TRG"), select = "TCRG-V1")
Vg1_old_TRG_V3 <- topCDR3(all.files, top = 10, keywords = c("Vg1", "old", "TRG"), select = "TCRG-V3")
Vg4_Th1_old_TRG_V4 <- topCDR3(all.files, top = 10, keywords = c("Vg4", "old", "TRG", "Th1-"), select = "TCRG-V4")
Vg4_Th17_old_TRG_V4 <- topCDR3(all.files, top = 10, keywords = c("Vg4", "old", "TRG", "Th17-"), select = "TCRG-V4")
Vg6_old_TRG_V6 <- topCDR3(all.files, top = 10, keywords = c("Vg6", "old", "TRG"), select = "TCRG-V6")

# Merge all clones
all.clones <- unique(c(Vg1_old_TRG_V1, Vg1_old_TRG_V3,
                Vg4_Th1_old_TRG_V4, Vg4_Th17_old_TRG_V4, 
                Vg6_old_TRG_V6))
```

## Create a data frame that contains the proportion of each clone in each libary

```{r collection}
TRG.files <- all.files[grepl("TRG", all.files)]
# Generate data info
c.names <- c(paste("Vg1_Th1-_old_TRG_V1", 
                   1:sum(grepl("Vg1_Th1-old", TRG.files)), 
                   sep =  "_"),
             paste("Vg1_Th1-_old_TRG_V3", 
                   1:sum(grepl("Vg1_Th1-old", TRG.files)), 
                   sep =  "_"),
             paste("Vg4_Th1-_old_TRG_V4", 
                   1:sum(grepl("Vg4_Th1-old", TRG.files)), 
                   sep =  "_"),
             paste("Vg4_Th17-_old_TRG_V4", 
                   1:sum(grepl("Vg4_Th17-old", TRG.files)), 
                   sep =  "_"),
             paste("Vg6_Th17-_old_TRG_V6", 
                   1:sum(grepl("Vg6_Th17-old", TRG.files)), 
                   sep =  "_"),
             paste("Vg1_Th1-_young_TRG_V1", 
                   1:sum(grepl("Vg1_Th1-young", TRG.files)), 
                   sep =  "_"),
             paste("Vg1_Th1-_young_TRG_V3", 
                   1:sum(grepl("Vg1_Th1-young", TRG.files)), 
                   sep =  "_"),
             paste("Vg4_Th1-_young_TRG_V4", 
                   1:sum(grepl("Vg4_Th1-young", TRG.files)), 
                   sep =  "_"),
             paste("Vg4_Th17-_young_TRG_V4", 
                   1:sum(grepl("Vg4_Th17-young", TRG.files)), 
                   sep =  "_"),
             paste("Vg6_Th17-_young_TRG_V6", 
                   1:sum(grepl("Vg6_Th17-young", TRG.files)), 
                   sep =  "_"))

mat <- matrix(data = NA, ncol = length(c.names), 
              nrow = length(all.clones))
colnames(mat) <- c.names
rownames(mat) <- all.clones

for(i in c.names){
  mat[,i] <- clones.fraction(all.files, i, all.clones)
}
```

## Visualization

```{r, fig.width=15, fig.height=20}
# With Vg6
pheatmap(mat, color = colorRampPalette(c("white", "blue", "red"))(100))

# Without Vg6
cur_mat <- mat[,!grepl("Vg6", colnames(mat))]
pheatmap(cur_mat, color = colorRampPalette(c("white", "blue", "red"))(100),
         cellwidth = 10, cellheight = 10, fontsize = 9)
```

