---
title: "Figure 3"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in data and libraries

```{r libraries, message=FALSE}
library(cowplot)
library(edgeR)
library(pheatmap)
library(viridis)
library(openxlsx)
```

```{r data}
# Raw counts
raw <- read.table("/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Data/FilteredCounts.txt", sep = "\t")

# Normalized counts
norm <- read.table("/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Data/NormCounts.txt", sep = "\t")

# Load marker genes for T cells
marker <- read.csv("/Users/nils/Dropbox (Cambridge University)/GammaDelta/Analysis/Data/Genelist.csv", stringsAsFactors = FALSE)
marker <- marker[marker[,1] != '',]
marker <- marker[grepl("ENS", marker$Ensembl.ID),]
rownames(marker) <- marker$Ensembl.ID

# Read in genenames
names <- read.table("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/Genenames.txt", sep = "\t")
rownames(names) <- names$V1
```

# Plot marker genes for these cells

```{r marker-genes}
for.heatmap <- norm[,order(colnames(norm))]

# Select genes of interest
genes <- c("Sell", "Ccr7", "Cxcr3", "Ptprc", "Cd27", "Ccl5", "Il2rb", "Relb", 
           "Id2", "Id3", "Tbx21", "Eomes", "Cd44", "Il7r", "Il1r1", "Il23r",
           "Cd163l1", "Ccr2", "Ccr6", "Blk", "Rorc", "Sox13", "Maf",
           "Lingo4", "Zbtb7b", "Tcf7", "Itk", "Bcl11b")
for.heatmap <- for.heatmap[rownames(names)[match(genes, names$V2)],]

pdf("../../../Dropbox (Cambridge University)/GammaDelta/Figures/Figure_3/Heatmap.pdf",
    width = 10, height = 15)
pheatmap(log10(for.heatmap + 1), 
         cluster_cols = FALSE, cluster_rows = FALSE, 
         labels_row = genes, 
         show_colnames = FALSE,
         cellheight = 8, fontsize = 7, color = viridis(100),
         annotation_col = data.frame(row.names = colnames(for.heatmap),
                      condition = sub("_DO.+$", "", colnames(for.heatmap))))
dev.off()
```

# Plot PCA of libraries

```{r pca}
pca <- prcomp(t(log10(norm + 1)))

# Only the young libraries
PC12.young <- ggplot(data.frame(condition = sub("_DO.+$", "", colnames(norm)[!grepl("old", colnames(norm))]),
                  PC1 = pca$x[!grepl("old", colnames(norm)),1],
                  PC2 = pca$x[!grepl("old", colnames(norm)),2])) +
  geom_point(aes(PC1, PC2, fill = condition), shape = 21, size = 2) + 
  scale_fill_brewer(palette = "Set1") + guides(fill = FALSE) + ylim(c(-20, 50)) +
  xlim(c(-30, 30))
ggsave("../../../Dropbox (Cambridge University)/GammaDelta/Figures/Figure_3/PCA_young.pdf", PC12.young,
       width = 4, height = 4)

# Now only the old
PC12.old <- ggplot(data.frame(condition = sub("_DO.+$", "", colnames(norm)[grepl("old", colnames(norm))]),
                  PC1 = pca$x[grepl("old", colnames(norm)),1],
                  PC2 = pca$x[grepl("old", colnames(norm)),2])) +
  geom_point(aes(PC1, PC2, fill = condition), shape = 21, size = 2, alpha = 0.5) + 
  scale_fill_brewer(palette = "Set1") + ylim(c(-20, 50)) +
  xlim(c(-30, 30)) + guides(fill = FALSE)
ggsave("../../../Dropbox (Cambridge University)/GammaDelta/Figures/Figure_3/PCA_old.pdf", PC12.old,
       width = 4, height = 4)

PC12.old.wGuides <- ggplot(data.frame(condition = sub("_DO.+$", "", colnames(norm)[grepl("old", colnames(norm))]),
                  PC1 = pca$x[grepl("old", colnames(norm)),1],
                  PC2 = pca$x[grepl("old", colnames(norm)),2])) +
  geom_point(aes(PC1, PC2, fill = condition), shape = 21, size = 2, alpha = 0.5) + 
  scale_fill_brewer(palette = "Set1") + ylim(c(-20, 50)) +
  xlim(c(-30, 30))
ggsave("../../../Dropbox (Cambridge University)/GammaDelta/Figures/Figure_3/PCA_old_withGuides.pdf", PC12.old.wGuides,
       width = 4, height = 4)


```

# Differential expression analysis

## Vg1

```{r DE}
# Save genes in list
cur_list <- list()
cur_data <- raw[,grepl("Vg1", colnames(raw))]

# Remove lowly expressed genes
cur_data <- cur_data[rowMeans(cur_data) > 10,]
cur_groups <- sapply(colnames(cur_data), function(n){unlist(strsplit(n, "_"))[3]})

# Differential expression analysis
y <- DGEList(counts=cur_data,
             group=cur_groups)
y <- calcNormFactors(y)
design <- model.matrix(~0+y$samples$group)
colnames(design) <- c("Old", "Young")
y <- estimateDisp(y,design)
  
fit <- glmQLFit(y,design, robust = TRUE)
qlf <- glmQLFTest(fit,coef=2, 
                contrast = makeContrasts(Old - Young, 
                                         levels = design))
cur_res_all <- topTags(qlf, n = nrow(qlf$table))$table

# Visualize results
p.Vg1 <- ggplot(data.frame(logFC = cur_res_all$logFC,
                  mean = cur_res_all$logCPM,
                  results = ifelse(cur_res_all$logFC > 0 & 
                                     cur_res_all$FDR < 0.1, "Old",
                                   ifelse(cur_res_all$logFC < 0 & 
                                     cur_res_all$FDR < 0.1, "Young", "Not DE")))) +
  geom_point(aes(mean, logFC, colour = results), size = 0.5) + 
  scale_color_manual(values = c("grey", "dark red", "dark blue")) +
  ggtitle("Vg1")

cur_res_all <- cur_res_all[cur_res_all$FDR < 0.1,]
cur_res_all$Symbol <- names[rownames(cur_res_all),2]
cur_res_all$Directionality <- ifelse(cur_res_all$logFC > 0, "Up in old", 
                                     "Up in young")
cur_list[["Vg1 Th1"]] <- cur_res_all
```


## Vg4 Th1

```{r DE}
cur_data <- raw[,grepl("Vg4_Th1_", colnames(raw))]

# Remove lowly expressed genes
cur_data <- cur_data[rowMeans(cur_data) > 10,]
cur_groups <- sapply(colnames(cur_data), function(n){unlist(strsplit(n, "_"))[3]})

# Differential expression analysis
y <- DGEList(counts=cur_data,
             group=cur_groups)
y <- calcNormFactors(y)
design <- model.matrix(~0+y$samples$group)
colnames(design) <- c("Old", "Young")
y <- estimateDisp(y,design)
  
fit <- glmQLFit(y,design, robust = TRUE)
qlf <- glmQLFTest(fit,coef=2, 
                contrast = makeContrasts(Old - Young, 
                                         levels = design))
cur_res_all <- topTags(qlf, n = nrow(qlf$table))$table

# Visualize results
p.Vg4_Th1 <- ggplot(data.frame(logFC = cur_res_all$logFC,
                  mean = cur_res_all$logCPM,
                  results = ifelse(cur_res_all$logFC > 0 & 
                                     cur_res_all$FDR < 0.1, "Old",
                                   ifelse(cur_res_all$logFC < 0 & 
                                     cur_res_all$FDR < 0.1, "Young", "Not DE")))) +
  geom_point(aes(mean, logFC, colour = results), size = 0.5) + 
  scale_color_manual(values = c("grey", "dark red", "dark blue")) +
  ggtitle("Vg4 Th1")

cur_res_all <- cur_res_all[cur_res_all$FDR < 0.1,]
cur_res_all$Symbol <- names[rownames(cur_res_all),2]
cur_res_all$Directionality <- ifelse(cur_res_all$logFC > 0, "Up in old", 
                                     "Up in young")
cur_list[["Vg4 Th1"]] <- cur_res_all
```

## Vg4 Th17

```{r DE}
cur_data <- raw[,grepl("Vg4_Th17_", colnames(raw))]

# Remove lowly expressed genes
cur_data <- cur_data[rowMeans(cur_data) > 10,]
cur_groups <- sapply(colnames(cur_data), function(n){unlist(strsplit(n, "_"))[3]})

# Differential expression analysis
y <- DGEList(counts=cur_data,
             group=cur_groups)
y <- calcNormFactors(y)
design <- model.matrix(~0+y$samples$group)
colnames(design) <- c("Old", "Young")
y <- estimateDisp(y,design)
  
fit <- glmQLFit(y,design, robust = TRUE)
qlf <- glmQLFTest(fit,coef=2, 
                contrast = makeContrasts(Old - Young, 
                                         levels = design))
cur_res_all <- topTags(qlf, n = nrow(qlf$table))$table

# Visualize results
p.Vg4_Th17 <- ggplot(data.frame(logFC = cur_res_all$logFC,
                  mean = cur_res_all$logCPM,
                  results = ifelse(cur_res_all$logFC > 0 & 
                                     cur_res_all$FDR < 0.1, "Old",
                                   ifelse(cur_res_all$logFC < 0 & 
                                     cur_res_all$FDR < 0.1, "Young", "Not DE")))) +
  geom_point(aes(mean, logFC, colour = results), size = 0.5) + 
  scale_color_manual(values = c("grey", "dark red", "dark blue")) +
  ggtitle("Vg4 Th17")

cur_res_all <- cur_res_all[cur_res_all$FDR < 0.1,]
cur_res_all$Symbol <- names[rownames(cur_res_all),2]
cur_res_all$Directionality <- ifelse(cur_res_all$logFC > 0, "Up in old", 
                                     "Up in young")
cur_list[["Vg4 Th17"]] <- cur_res_all
```

## Vg6 Th17

```{r DE}
cur_data <- raw[,grepl("Vg6", colnames(raw))]

# Remove lowly expressed genes
cur_data <- cur_data[rowMeans(cur_data) > 10,]
cur_groups <- sapply(colnames(cur_data), function(n){unlist(strsplit(n, "_"))[3]})

# Differential expression analysis
y <- DGEList(counts=cur_data,
             group=cur_groups)
y <- calcNormFactors(y)
design <- model.matrix(~0+y$samples$group)
colnames(design) <- c("Old", "Young")
y <- estimateDisp(y,design)
  
fit <- glmQLFit(y,design, robust = TRUE)
qlf <- glmQLFTest(fit,coef=2, 
                contrast = makeContrasts(Old - Young, 
                                         levels = design))
cur_res_all <- topTags(qlf, n = nrow(qlf$table))$table

# Visualize results
p.Vg6 <- ggplot(data.frame(logFC = cur_res_all$logFC,
                  mean = cur_res_all$logCPM,
                  results = ifelse(cur_res_all$logFC > 0 & 
                                     cur_res_all$FDR < 0.1, "Old",
                                   ifelse(cur_res_all$logFC < 0 & 
                                     cur_res_all$FDR < 0.1, "Young", "Not DE")))) +
  geom_point(aes(mean, logFC, colour = results), size = 0.5) + 
  scale_color_manual(values = c("grey", "dark red", "dark blue")) +
  ggtitle("Vg6")

cur_res_all <- cur_res_all[cur_res_all$FDR < 0.1,]
cur_res_all$Symbol <- names[rownames(cur_res_all),2]
cur_res_all$Directionality <- ifelse(cur_res_all$logFC > 0, "Up in old", 
                                     "Up in young")
cur_list[["Vg6 Th17"]] <- cur_res_all

# Save list
write.xlsx(cur_list, "../../../Dropbox (Cambridge University)/Gammadelta T cell aging/2_Figures/Tables/Table_S1_notFinal.xlsx")
```

# Save figure

```{r}
final <- plot_grid(p.Vg1, p.Vg4_Th1, p.Vg4_Th17, p.Vg6, nrow = 1)
ggsave("../../../Dropbox (Cambridge University)/GammaDelta/Figures/Figure_3/DE.pdf", final,
       width = 20, height = 4)
```